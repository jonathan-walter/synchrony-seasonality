---
title: "Seasonality in Spatial Synchrony"
author: "Jonathan Walter"
date: "9/12/2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

setwd("~/GitHub/synchrony-seasonality")
```

## Overview

This R Markdown document organizes for completeness and replicability a series of simulations examining how seasonality in the degree of environmental spatial synchrony affects population spatial synchrony, extinction risk, and detection and attribution of drivers of population spatial synchrony.

# Effects of seasonality on synchrony, linear population dynamics

First, compare analytical solution to an equivalent simulation model to confirm it works

```{r linear.compare, echo=FALSE, cache=TRUE}
library(parallel)
library(lhs)
source("~/GitHub/synchrony-seasonality/Fn_popSynchByStage_linear_20210315.R")

# nn<-200
# 
# set.seed(666)
# hypercube<-optimumLHS(n=nn, k=6)

tmax=10000
a1=0.1
a2=0.4
rho.b=0.5
rho.w=0.8
sd.b=0.5
sd.w=sd.b
nlocs=2

linear.test<-popSynchByStage.linear(a1, a2, rho.b, rho.w, sd.b, sd.w, tmax, nlocs, ret.eb=TRUE, ret.ew=TRUE)
  
analytical.solution<-function(a2, eb, ew){
  
  ax = (1 - a2)
  var.b = var(eb[1,])
  var.w = var(ew[1,])
  eb1 = eb[1,]
  eb2 = eb[2,]
  ew1 = ew[1,]
  ew2 = ew[2,]
  
  return((ax^2*cov(eb1,eb2) + ax*cov(eb1,ew2) + ax*cov(ew1,eb2) + cov(ew1,ew2))/(ax^2*var.b + var.w))
}

cor(linear.test$Nt[1,-c(1:100)], linear.test$Nt[2,-c(1:100)])

analytical.solution(a2, linear.test$eb[,-c(1:100)], linear.test$ew[,-c(1:100)])


```

Next, independently and simultaneously vary environmental correlation while holding other factors constant.
Still using the analytical solution.
```{r analytical.surface, echo=FALSE, cache=TRUE}

a2=0.5
rho.b=seq(0,1,by=0.01)
rho.w=rho.b
sd.b=0.5
sd.w=sd.b
nlocs=2

analytical.solution2<-function(a2, rho.b, rho.w, sd.b, sd.w){ #assumes that cov(eb1,ew2) = 0 & cov(ew1,eb2) = 0

  ax = (1 - a2)
  var.b = sd.b^2
  var.w = sd.w^2
  
  return((ax^2*(rho.b*var.b) + (rho.w*var.w))/(ax^2*var.b + var.w))
}
  
varrhos.analytical1<-matrix(NA, length(rho.b), length(rho.w))
for(ii in 1:length(rho.b)){
  for(jj in 1:length(rho.w)){
    varrhos.analytical1[ii,jj]<-analytical.solution2(a2, rho.b[ii], rho.w[jj], sd.b, sd.w)
  }
}

#vary a2 while holding spatial synchrony and driver variance constant
a2seq<-seq(0,1,by=0.05)

a2_v1.analytical<-rep(NA, length(a2seq))
a2_v2.analytical<-rep(NA, length(a2seq))
a2_v3.analytical<-rep(NA, length(a2seq))

for(ii in 1:length(a2seq)){
  
  a2_v1.analytical[ii]<-analytical.solution2(a2seq[ii], rho.b=0.7, rho.w=0.3, sd.b, sd.w)
  a2_v2.analytical[ii]<-analytical.solution2(a2seq[ii], rho.b=0.3, rho.w=0.7, sd.b, sd.w)
  a2_v3.analytical[ii]<-analytical.solution2(a2seq[ii], rho.b=0.5, rho.w=0.5, sd.b, sd.w)
  
}


## change driver variances while pinning synchrony and a2 <------------------------------------------------------------
sd.bseq<-seq(0,1,0.05)
sd.wseq<-seq(0,1,0.05)

sd.b_v1.analytical<-rep(NA, length(sd.bseq))
sd.w_v1.analytical<-rep(NA, length(sd.wseq))

sd.b_v2.analytical<-rep(NA, length(sd.bseq))
sd.w_v2.analytical<-rep(NA, length(sd.wseq))

sd.b_v3.analytical<-rep(NA, length(sd.bseq))
sd.w_v3.analytical<-rep(NA, length(sd.wseq))

for(ii in 1:length(sd.bseq)){
  
  sd.b_v1.analytical[ii]<-analytical.solution2(a2, rho.b=0.3, rho.w=0.7, sd.b=sd.bseq[ii], sd.w=sd.w)
  sd.w_v1.analytical[ii]<-analytical.solution2(a2, rho.b=0.3, rho.w=0.7, sd.b=sd.b, sd.w=sd.wseq[ii])
  
  sd.b_v2.analytical[ii]<-analytical.solution2(a2, rho.b=0.7, rho.w=0.3, sd.b=sd.bseq[ii], sd.w=sd.w)
  sd.w_v2.analytical[ii]<-analytical.solution2(a2, rho.b=0.7, rho.w=0.3, sd.b=sd.b, sd.w=sd.wseq[ii])
  
  sd.b_v3.analytical[ii]<-analytical.solution2(a2, rho.b=0.5, rho.w=0.5, sd.b=sd.bseq[ii], sd.w=sd.w)
  sd.w_v3.analytical[ii]<-analytical.solution2(a2, rho.b=0.5, rho.w=0.5, sd.b=sd.b, sd.w=sd.wseq[ii])
  
}

pal<-colorRampPalette(colors=c("red","white","blue"))


#Make nice figure!
png("~/GitHub/synchrony-seasonality/fig1_analytical.png", units="in", res=300, width=3, height=8)

par(mfrow=c(3,1), mar=c(3.5,3.5,1.5,1), mgp=c(1.7,0.5,0))
#varying synchrony
image(rho.b, rho.w, varrhos.analytical1, zlim=c(-1,1), col=pal(50),
      xlab=expression(rho[b]), ylab=expression(rho[w]))
contour(rho.b, rho.w, varrhos.analytical1, add=T)
mtext(expression(paste(a[2]," = 0.5, var(",epsilon[b],") = var(",epsilon[w],") = 0.25")), cex=0.6)

#varying a2
plot(a2seq, a2_v1.analytical, type="l", ylim=c(0,1), xlab=expression(a[2]), ylab="Population synchrony")
lines(a2seq, a2_v2.analytical, lty=2)
lines(a2seq, a2_v3.analytical, lty=3)
mtext(expression(paste("var(",epsilon[b],") = var(",epsilon[w],") = 0.25")), cex=0.6)
legend("topright", legend=c(expression(paste(rho[b]," = 0.3, ",rho[w]," = 0.7")), 
                            expression(paste(rho[b]," =  ",rho[w]," = 0.5")), 
                            expression(paste(rho[b]," = 0.7, ",rho[w]," = 0.3"))), 
       lty=c(1,3,2), bty="n", cex=0.9)

#varying driver variances
plot(sd.bseq, sd.b_v1.analytical, type="l", ylim=c(0,1), xlab="Driver variance",
     ylab="Population synchrony")
lines(sd.wseq, sd.w_v1.analytical, lty=1, col="red")

lines(sd.bseq, sd.b_v2.analytical, lty=2)
lines(sd.wseq, sd.w_v2.analytical, lty=2, col="red")

lines(sd.bseq, sd.b_v3.analytical, lty=1)
lines(sd.wseq, sd.w_v3.analytical, lty=3, col="red")
mtext(expression(paste(a[2]," = 0.5")), cex=0.6)
legend("top", ncol=2, legend=c(expression(paste("changing var(",epsilon[b],")"))
                               , expression(paste("changing var(",epsilon[w],")"))), 
       lty=1, col=c("black","red"), bty="n", cex=0.9)
legend("bottom", ncol=2, legend=c(expression(paste(rho[b]," = 0.3, ",rho[w]," = 0.7")), 
                            expression(paste(rho[b]," = ",rho[w]," = 0.5")), 
                            expression(paste(rho[b]," = 0.7, ",rho[w]," = 0.3"))), 
       lty=c(1,3,2), bty="n", cex=0.9)

dev.off()

```


# Effects of seasonality on synchrony and extinction, nonlinear dynamics 

This section relies on simulation.
First, examine sensitivity of model outcomes (spatial synchrony) to parameter values.
Parameter space is sampled using latin hypercube. 

```{r nlin.sensitivity, echo=FALSE, cache=TRUE}
rm(list=ls())
library(parallel)
library(lhs)
source("~/GitHub/synchrony-seasonality/Fn_synchsim_mainmodel.R")
nn<-250

set.seed(667)
hypercube<-optimumLHS(n=nn, k=5)

r=qunif(hypercube[,1],0.1,2)
Kb=10
Kw=Kb
rho.b=hypercube[,2]
rho.w=hypercube[,3]
sd.b=qunif(hypercube[,4],1/3,3)
sd.w=qunif(hypercube[,5],1/3,3)
Db=0#runif(nn,0,0.4)
Dw=0
tmax=1100
burn=100
nlocs=2

ncores=detectCores()-4

cl<-makeCluster(ncores)
ddall.sample<-mcmapply(synchsim_main, r=r, Kb=Kb, Kw=Kw, rho.b=rho.b, rho.w=rho.w,
                       sd.b=sd.b, sd.w=sd.w, Db=Db, Dw=Dw, tmax=tmax, nlocs=nlocs, SIMPLIFY = F)
stopCluster(cl)

getNtcor<-function(inlist){ #extract synchrony in Nt
  out<-rep(NA, length(inlist))
  for(ii in 1:length(inlist)){
    tmp<-log(inlist[[ii]]$Nt[,-c(1:burn)])
    out[ii]<-cor(t(tmp))[2,1]
  }
  return(out)
}

  
sampres.ddall<-data.frame(rhoN=getNtcor(ddall.sample), #scale predictors to standardize effect sizes
                       r=r,rho.b=scale(rho.b),sd.b=scale(sd.b),sd.w=scale(sd.w),
                       rho.w=scale(rho.w),Db=scale(Db))

lm.samp.rhoN<-lm(rhoN~r+rho.b+rho.w+sd.b+sd.w+sd.b*rho.b+sd.w*rho.w+rho.b*rho.w, data=sampres.ddall, na.action=na.exclude)
summary(lm.samp.rhoN)

# lm.samp.El<-lm(log(El+1)~r+rho.b+rho.w+sd.b+sd.w+sd.b*rho.b+sd.w*rho.w+rho.b*rho.w, data=sampres.ddall, na.action=na.exclude)
# summary(lm.samp.El)
# 
# lm.samp.Eg<-lm(log(Eg+1)~r+rho.b+rho.w+sd.b+sd.w+sd.b*rho.b+sd.w*rho.w+rho.b*rho.w, data=sampres.ddall, na.action=na.exclude)
# summary(lm.samp.Eg)

modsumm.add<-summary(lm.samp.rhoN)

png("fig2_parameffects_sims.png", units="in", res=300, 
     width=6.5, height=3.25)
par(mar=c(7,5,2,2))
barplot(lm.samp.rhoN$coefficients[-1], las=2, ylim=c(-0.05,0.27), ylab = "Synchrony")
text(seq(from=0.6,by=1.2,length.out=8),lm.samp.rhoN$coefficients[-1],paste0("p=",round(modsumm.add$coefficients[-1,4],2)),pos=3,offset=0.5)
dev.off()

# save(modsumm.add, file="modsumm_main.RData")

```

Now, vary synchrony in breeding and overwintering environment while holding other parameters constant.
The main model is compared against two alternates: 
1) where population dynamics have breeding and overwintering seasons, but the environmental conditions are identical.
2) where population dynamics do not have distinct seasons but there are two environmental drivers.

```{r ddall.varrhos, echo=FALSE, cache=TRUE}
library(parallel)
source("~/GitHub/synchrony-seasonality/Fn_synchsim_mainmodel.R")
source("~/GitHub/synchrony-seasonality/Fn_synchsim_altmodel_sameEnvironment.R")
source("~/GitHub/synchrony-seasonality/Fn_synchsim_altmodel_noOverwintering.R")

scentxt<-"r08Db0Kb10"

rho<-seq(0,1,by=0.05)
rho.b<-rep(expand.grid(rho,rho)[,1],each=500)
rho.w<-rep(expand.grid(rho,rho)[,2],each=500)
r=0.8
Kb=10
Kw=Kb
sd.b=1.8
sd.w=1.8
Db=0.01
Dw=0
nlocs=2
tmax=250
burn=50

ncores=detectCores()-4

cl<-makeCluster(ncores)
varrhos.main<-mcmapply(synchsim_main,r=r,Kb=Kb,Kw=Kw,rho.b=rho.b,rho.w=rho.w,
                        sd.b=sd.b,sd.w=sd.w,Db=Db,tmax=tmax,nlocs=nlocs, SIMPLIFY = F)
varrhos.same<-mcmapply(synchsim_sameEnv,r=r,Kb=Kb, Kw=Kw, rho.b=rho.b,
                        sd.b=sd.b,Db=Db,tmax=tmax,nlocs=nlocs, SIMPLIFY = F)
varrhos.noow<-mcmapply(synchsim_noOverwint,r=r,K=Kb,rho.b=rho.b,rho.w=rho.w,
                        sd.b=sd.b,sd.w=sd.w,Db=Db,tmax=tmax,nlocs=nlocs, SIMPLIFY = F)

stopCluster(cl)


getNtcor<-function(inlist){ #extract synchrony in Nt
  out<-rep(NA, length(inlist))
  for(ii in 1:length(inlist)){
    tmp<-log(inlist[[ii]]$Nt[,-c(1:50)]+1)
    tmprho<-cor(t(tmp), use = "pairwise.complete.obs")
    out[ii]<-mean(tmprho[lower.tri(tmprho)], na.rm=T)
  }
  return(out)
}

getBtcor<-function(inlist){ #extract synchrony in Nt
  out<-rep(NA, length(inlist))
  for(ii in 1:length(inlist)){
    tmp<-log(inlist[[ii]]$Bt[,-c(1:50)]+1)
    tmprho<-cor(t(tmp), use = "pairwise.complete.obs")
    out[ii]<-mean(tmprho[lower.tri(tmprho)], na.rm=T)
  }
  return(out)
}

# getEl<-function(inlist){ #extract local extinction rate
#   out<-rep(NA, length(inlist))
#   for(ii in 1:length(inlist)){
#     tmp<-inlist[[ii]]$Nt[,-c(1:50)]
#     out[ii]<-sum(tmp==0,na.rm=T)/sum(!is.na(tmp))
#   }
#   return(out)
# }

getEg<-function(inlist){ #extract global extinction rate <----------- CHECK THIS FUNCTION
  out<-rep(NA, length(inlist))
  for(ii in 1:length(inlist)){
    tmp<-inlist[[ii]]$Nt[,-c(1:burn)]
    if(all(is.na(tmp))){out[ii]<-NA}
    else if(!any(is.na(tmp[,ncol(tmp)]))){out[ii]<-0}
    else{out[ii]<-1/(max(rowSums(!is.na(tmp)))*2)}
  }
  return(out)
}

Ntcor.main<-data.frame(rho.b=rho.b, rho.w=rho.w, Ntcor=getNtcor(varrhos.main))
Ntcor.main<-aggregate(Ntcor.main, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Ntcor.main<-matrix(Ntcor.main$Ntcor, nrow=length(rho), ncol=length(rho))

Btcor.main<-data.frame(rho.b=rho.b, rho.w=rho.w, Btcor=getBtcor(varrhos.main))
Btcor.main<-aggregate(Btcor.main, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Btcor.main<-matrix(Btcor.main$Btcor, nrow=length(rho), ncol=length(rho))

Eg.main<-data.frame(rho.b=rho.b, rho.w=rho.w, Eg=getEg(varrhos.main))
Eg.main<-aggregate(Eg.main, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Eg.main<-matrix(Eg.main$Eg, nrow=length(rho), ncol=length(rho))


Ntcor.same<-data.frame(rho.b=rho.b, rho.w=rho.w, Ntcor=getNtcor(varrhos.same))
Ntcor.same<-aggregate(Ntcor.same, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Ntcor.same<-matrix(Ntcor.same$Ntcor, nrow=length(rho), ncol=length(rho))

Btcor.same<-data.frame(rho.b=rho.b, rho.w=rho.w, Btcor=getBtcor(varrhos.same))
Btcor.same<-aggregate(Btcor.same, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Btcor.same<-matrix(Btcor.same$Btcor, nrow=length(rho), ncol=length(rho))

Eg.same<-data.frame(rho.b=rho.b, rho.w=rho.w, Eg=getEg(varrhos.same))
Eg.same<-aggregate(Eg.same, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Eg.same<-matrix(Eg.same$Eg, nrow=length(rho), ncol=length(rho))


Ntcor.noow<-data.frame(rho.b=rho.b, rho.w=rho.w, Ntcor=getNtcor(varrhos.noow))
Ntcor.noow<-aggregate(Ntcor.noow, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Ntcor.noow<-matrix(Ntcor.noow$Ntcor, nrow=length(rho), ncol=length(rho))

Btcor.noow<-data.frame(rho.b=rho.b, rho.w=rho.w, Btcor=getBtcor(varrhos.noow))
Btcor.noow<-aggregate(Btcor.noow, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Btcor.noow<-matrix(Btcor.noow$Btcor, nrow=length(rho), ncol=length(rho))

Eg.noow<-data.frame(rho.b=rho.b, rho.w=rho.w, Eg=getEg(varrhos.noow))
Eg.noow<-aggregate(Eg.noow, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Eg.noow<-matrix(Eg.noow$Eg, nrow=length(rho), ncol=length(rho))


# get difference matrices

diff.NtBtcor.main<-Btcor.main-Ntcor.main
diff.NtBtcor.same<-Btcor.same-Ntcor.same
diff.NtBtcor.noow<-Ntcor.noow-Btcor.noow

diff1.Ntcor <- Ntcor.main-Ntcor.same
diff1.Eg <- Eg.main-Eg.same

diff2.Ntcor <- Ntcor.main-Ntcor.noow
diff2.Eg <- Eg.main-Eg.noow



pal<-colorRampPalette(colors=c("red","white","blue"))


## Make figure comparing syncrhony in different seasons

png(paste0("~/GitHub/synchrony-seasonality/fig3_compare_seasons.png"), units="in", res=300, width=6.4, height=6.4)

par(mfrow=c(3,3), mar=c(1.8,1.8,0.5,0), mgp=c(2.7,0.5,0), tcl=-0.3, oma=c(1.1,2.7,1.1,1))
#main model
image(rho, rho, Ntcor.main, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-1,1))
tmpdf<-data.frame(z=c(Ntcor.main), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T)
text(0.05,0.95,"a)")

image(rho, rho, Btcor.main, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-1,1))
tmpdf<-data.frame(z=c(Btcor.main), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T)
text(0.05,0.95,"b)")

image(rho, rho, diff.NtBtcor.main, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-.6,.6))
tmpdf<-data.frame(z=c(diff.NtBtcor.main), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T)
text(0.05,0.95,"c)")

#same environment
image(rho, rho, Ntcor.same, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-1,1))
tmpdf<-data.frame(z=c(Ntcor.same), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T)
text(0.05,0.95,"d)")

image(rho, rho, Btcor.same, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-1,1))
tmpdf<-data.frame(z=c(Btcor.same), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T)
text(0.05,0.95,"e)")

image(rho, rho, diff.NtBtcor.same, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-.6,.6))
tmpdf<-data.frame(z=c(diff.NtBtcor.same), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T)
text(0.05,0.95,"f)")

#no overwintering
image(rho, rho, Ntcor.noow, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-1,1))
tmpdf<-data.frame(z=c(Ntcor.noow), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T)
text(0.05,0.95,"g)")

image(rho, rho, Btcor.noow, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-1,1))
tmpdf<-data.frame(z=c(Btcor.noow), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T)
text(0.05,0.95,"h)")

image(rho, rho, diff.NtBtcor.noow, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-.6,.6))
tmpdf<-data.frame(z=c(diff.NtBtcor.noow), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T)
text(0.05,0.95,"i)")

mtext("Spatial synchrony of breeding season environment",1,outer=T,cex=0.8)
mtext("Overwintering synchrony",2,outer=T,cex=0.8, line=1.5)
mtext("Main model", 2, outer=T, at=5/6, cex=0.8, line=0)
mtext("Alt: same environment", 2, outer=T, at=1/2, cex=0.8, line=0)
mtext("Alt: no overwintering", 2, outer=T, at=1/6, cex=0.8, line=0)
mtext("cor(Nt)", outer=T, at=1/6, cex=0.8, line=-0.25)
mtext("cor(Bt)", outer=T, at=3/6, cex=0.8, line=-0.25)
mtext("cor(Bt)-cor(Nt)", outer=T, at=5/6, cex=0.8, line=-0.25)

dev.off()



#make figure comparing main model to alternate

png("~/GitHub/synchrony-seasonality/fig4_compare_alternates.png", units="in", res=300, width=6, height=4.42)

par(mfcol=c(2,3), mar=c(2,2,2.5,1), oma=c(1.5,1.5,0,0),mgp=c(2,0.6,0), tcl=-0.4)
#main model
image(rho, rho, Ntcor.main, xlab="", ylab="", asp=1, 
      main="", col=pal(50), zlim=c(-1,1))
tmpdf<-data.frame(z=c(Ntcor.main), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T)
mtext("Main model",3,line=0.1,cex=0.7)
text(0.05,0.95,"a)")

image(rho, rho, Eg.main, xlab="", ylab="", asp=1, 
      main="",
      col=pal(50), zlim=c(-.15,.15))
tmpdf<-data.frame(z=c(Eg.main), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T)
mtext("Main model",3,line=0.1, cex=0.7)
text(0.05,0.95,"g)")


#difference - same environment across seasons
image(rho, rho, Ntcor.same, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-1,1))
tmpdf<-data.frame(z=c(Ntcor.same), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T)
mtext("Alt: same environment",3,line=0.1,cex=0.7)
mtext("Population spatial synchrony",3,line=1.1,cex=0.9)
text(0.05,0.95,"b)")

image(rho, rho, Eg.same, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-.23,.23))
tmpdf<-data.frame(z=c(Eg.same), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T)
mtext("Alt: same environment",3,line=0.1,cex=0.7)
mtext("Extinction rate",3,line=1.1,cex=0.9)
text(0.05,0.95,"h)")


#difference - no overwintering
image(rho, rho, Ntcor.noow, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-1,1))
tmpdf<-data.frame(z=c(Ntcor.noow), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T)
mtext("Alt: no overwintering",3,line=0.1,cex=0.7)
text(0.05,0.95,"c)")

image(rho, rho, Eg.noow, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-.015,.015))
tmpdf<-data.frame(z=c(Eg.noow), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T)
mtext("Alt: no overwintering",3,line=0.1,cex=0.7)
text(0.05,0.95,"i)")

mtext("Spatial synchrony of breeding season environment",1,outer=T,cex=0.9)
mtext("Spatial synchrony of overwintering season environment",2,outer=T,cex=0.9)

dev.off()



```


# Nothing below here is edited! 

# Mechanism detection, density dependent model

This is possibly being axed, not run for now.
 ```{r ricker.detection, echo=FALSE, cache=TRUE}
# rm(list=ls())
# library(parallel)
# source("~/Box Sync/SynchronyLifestageModel/Fn_synchsim_main_20180822.R")
# nn=1000
# r=rep(0.8,nn)
# Kb=10
# Kw=Kb
# sd.b=Kb/3.5
# rho.b=0.7
# sd.w=Kw/3.5
# rho.w=0.7
# Db=0.1
# Dw=0
# tmax=150
# nlocs=2
# ret.Bt=TRUE
# ret.eb=TRUE
# ret.ew=TRUE
# 
# ncores=detectCores()-1
# 
# cl<-makeCluster(ncores)
# nonlin.detect<-mcmapply(synchsim_main, r=r, Kb=Kb, Kw=Kw, rho.b=rho.b, rho.w=rho.w,
#                        sd.b=sd.b, sd.w=sd.w, Db=Db, Dw=Dw, tmax=tmax, nlocs=nlocs,
#                        ret.Bt=ret.Bt, ret.eb=ret.eb, ret.ew=ret.ew, SIMPLIFY = F)
# stopCluster(cl)
# 
# detect.results<-matrix(NA,nn,4)# Nt*eb, Nt*ew, Bt*eb, Bt*ew
# for(ii in 1:nn){
#   
#   tt<-1:(tmax-50)
#   rep<-nonlin.detect[[ii]]
#   
#   if(any(is.na(rep$Nt))){next}
#   
#   Ntclean<-cleandat(rep$Nt[,-c(1:50)],tt,clev=4)$cdat
#   Btclean<-cleandat(rep$Bt[,-c(1:50)],tt,clev=4)$cdat
#   ebclean<-cleandat(rep$eb[,-c(1:50)],tt,clev=3)$cdat
#   ewclean<-cleandat(rep$ew[,-c(1:50)],tt,clev=3)$cdat
#   
#   coh1<-coh(Ntclean,ebclean,tt,norm="powall",sigmethod="fast",scale.max.input = 10)
#   coh2<-coh(Ntclean,ewclean,tt,norm="powall",sigmethod="fast",scale.max.input = 10)
#   coh3<-coh(Btclean,ebclean,tt,norm="powall",sigmethod="fast",scale.max.input = 10)
#   coh4<-coh(Btclean,ewclean,tt,norm="powall",sigmethod="fast",scale.max.input = 10)
#   
#   coh1<-bandtest(coh1, band=c(0,Inf))
#   coh2<-bandtest(coh2, band=c(0,Inf))
#   coh3<-bandtest(coh3, band=c(0,Inf))
#   coh4<-bandtest(coh4, band=c(0,Inf))
#   
#   detect.results[ii,1]<-as.numeric(coh1$bandp[3])
#   detect.results[ii,2]<-as.numeric(coh2$bandp[3])
#   detect.results[ii,3]<-as.numeric(coh3$bandp[3])
#   detect.results[ii,4]<-as.numeric(coh4$bandp[3])
#   
# }
# 
# print(mean(detect.results[,1]<0.05,na.rm=T))
# print(mean(detect.results[,2]<0.05,na.rm=T))
# print(mean(detect.results[,3]<0.05,na.rm=T))
# print(mean(detect.results[,4]<0.05,na.rm=T))
```


# Dispersal rate manipulations

First, change dispersal rates for additive noise models:
```{r ddall.varrhos.Db0, echo=FALSE, cache=TRUE}
library(parallel)
source("~/Box Sync/SynchronyLifestageModel/Fn_synchsim_main_20180822.R")
source("~/Box Sync/SynchronyLifestageModel/Fn_synchsim_main_alt_20180827.R")
source("~/Box Sync/SynchronyLifestageModel/Fn_synchsim_sameEnv_20181016.R")

scentxt<-"r08Db00Kb10"

rho<-seq(0,1,by=0.05)
rho.b<-rep(expand.grid(rho,rho)[,1],each=100)
rho.w<-rep(expand.grid(rho,rho)[,2],each=100)
r=0.8
Kb=10
Kw=Kb
sd.b=Kb/3.5
sd.w=Kw/3.5
Db=0
Dw=0
nlocs=2
tmax=550

ncores=detectCores()-1

cl<-makeCluster(ncores)
varrhos.main<-mcmapply(synchsim_main,r=r,Kb=Kb,Kw=Kw,rho.b=rho.b,rho.w=rho.w,
                        sd.b=sd.b,sd.w=sd.w,Db=Db,tmax=tmax,nlocs=nlocs, SIMPLIFY = F)
varrhos.alt<-mcmapply(synchsim_main_alt,r=r,Kb=Kb,Kw=Kw,rho.b=rho.b,rho.w=rho.w,
                        sd.b=sd.b,sd.w=sd.w,Db=Db,tmax=tmax,nlocs=nlocs, SIMPLIFY = F)
varrhos.basic<-mcmapply(synchsim_sameEnv,r=r,K=Kb,rho.b=rho.b,rho.w=rho.w,
                        sd.b=sd.b,sd.w=sd.w,Db=Db,tmax=tmax,nlocs=nlocs, SIMPLIFY = F)

stopCluster(cl)


getNtcor<-function(inlist){ #extract synchrony in Nt
  out<-rep(NA, length(inlist))
  for(ii in 1:length(inlist)){
    tmp<-log(inlist[[ii]]$Nt[,-c(1:50)]+1)
    tmprho<-cor(t(tmp), use = "pairwise.complete.obs")
    out[ii]<-mean(tmprho[lower.tri(tmprho)])
  }
  return(out)
}

getBtcor<-function(inlist){ #extract synchrony in Nt
  out<-rep(NA, length(inlist))
  for(ii in 1:length(inlist)){
    tmp<-log(inlist[[ii]]$Bt[,-c(1:50)]+1)
    tmprho<-cor(t(tmp), use = "pairwise.complete.obs")
    out[ii]<-mean(tmprho[lower.tri(tmprho)])
  }
  return(out)
}

getEl<-function(inlist){ #extract local extinction rate
  out<-rep(NA, length(inlist))
  for(ii in 1:length(inlist)){
    tmp<-inlist[[ii]]$Nt[,-c(1:50)]
    out[ii]<-sum(tmp==0,na.rm=T)/sum(!is.na(tmp))
  }
  return(out)
}

getEg<-function(inlist){ #extract global extinction rate
  out<-rep(NA, length(inlist))
  for(ii in 1:length(inlist)){
    tmp<-inlist[[ii]]$Nt[,-c(1:50)]
    if(all(is.na(tmp))){out[ii]<-NA}
    else if(sum(colSums(tmp)==0, na.rm=T)==0){out[ii]<-0}
    else{out[ii]<-1/(which(colSums(tmp)==0)+50)}
  }
  return(out)
}

Ntcor.df<-data.frame(rho.b=rho.b, rho.w=rho.w, Ntcor=getNtcor(varrhos.main))
Ntcor.agg<-aggregate(Ntcor.df, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Ntcor.mat<-matrix(Ntcor.agg$Ntcor, nrow=length(rho), ncol=length(rho))

Btcor.df<-data.frame(rho.b=rho.b, rho.w=rho.w, Btcor=getBtcor(varrhos.main))
Btcor.agg<-aggregate(Btcor.df, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Btcor.mat<-matrix(Btcor.agg$Btcor, nrow=length(rho), ncol=length(rho))

Ntcor.df.alt<-data.frame(rho.b=rho.b, rho.w=rho.w, Ntcor=getNtcor(varrhos.alt))
Ntcor.agg.alt<-aggregate(Ntcor.df.alt, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Ntcor.mat.alt<-matrix(Ntcor.agg.alt$Ntcor, nrow=length(rho), ncol=length(rho))

Ntcor.df.br<-data.frame(rho.b=rho.b, rho.w=rho.w, Ntcor=getNtcor(varrhos.basic))
Ntcor.agg.br<-aggregate(Ntcor.df.br, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Ntcor.mat.br<-matrix(Ntcor.agg.br$Ntcor, nrow=length(rho), ncol=length(rho))

El.df<-data.frame(rho.b=rho.b, rho.w=rho.w, El=getEl(varrhos.main))
El.agg<-aggregate(El.df, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
El.mat<-matrix(El.agg$El, nrow=length(rho), ncol=length(rho))

El.df.alt<-data.frame(rho.b=rho.b, rho.w=rho.w, El=getEl(varrhos.alt))
El.agg.alt<-aggregate(El.df.alt, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
El.mat.alt<-matrix(El.agg.alt$El, nrow=length(rho), ncol=length(rho))

El.df.br<-data.frame(rho.b=rho.b, rho.w=rho.w, El=getEl(varrhos.basic))
El.agg.br<-aggregate(El.df.br, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
El.mat.br<-matrix(El.agg.br$El, nrow=length(rho), ncol=length(rho))

Eg.df<-data.frame(rho.b=rho.b, rho.w=rho.w, Eg=getEg(varrhos.main))
Eg.agg<-aggregate(Eg.df, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Eg.mat<-matrix(Eg.agg$Eg, nrow=length(rho), ncol=length(rho))

Eg.df.alt<-data.frame(rho.b=rho.b, rho.w=rho.w, Eg=getEg(varrhos.alt))
Eg.agg.alt<-aggregate(Eg.df.alt, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Eg.mat.alt<-matrix(Eg.agg.alt$Eg, nrow=length(rho), ncol=length(rho))

Eg.df.br<-data.frame(rho.b=rho.b, rho.w=rho.w, Eg=getEg(varrhos.basic))
Eg.agg.br<-aggregate(Eg.df.br, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Eg.mat.br<-matrix(Eg.agg.br$Eg, nrow=length(rho), ncol=length(rho))

#avg.mat<-matrix(rowMeans(expand.grid(rho,rho)), nrow=length(rho), ncol=length(rho))
diff.Ntcor<-Ntcor.mat-Ntcor.mat.alt
diff.El<-El.mat-El.mat.alt
diff.Eg<-Eg.mat-Eg.mat.alt

diff2.Ntcor<-Ntcor.mat-Ntcor.mat.br
diff2.El<-El.mat-El.mat.br
diff2.Eg<-Eg.mat-Eg.mat.br

diff.NtBtcor<-Ntcor.mat-Btcor.mat

pal<-colorRampPalette(colors=c("red","white","blue"))

png(paste0("~/Box Sync/SynchronyLifestageModel/plotoutput/appendix_comparison_addnoise_",scentxt,".png"), units="in", res=300, width=6, height=6.55)

par(mfcol=c(3,3), mar=c(2,2,2.5,1), oma=c(1.5,1.5,0,0),mgp=c(2,0.6,0), tcl=-0.4)
#main model
image(rho, rho, Ntcor.mat, xlab="", ylab="", asp=1, 
      main="", col=pal(50), zlim=c(-1,1))
tmpdf<-data.frame(z=c(Ntcor.mat), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T)
mtext("Main model",3,line=0.1,cex=0.7)
text(0.05,0.95,"a)")

image(rho, rho, El.mat, xlab="", ylab="", asp=1, 
      main="", col=pal(50), zlim=c(-.25,.25))
tmpdf<-data.frame(z=c(El.mat), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T, levels=c(0.09,0.11,0.13,0.15,0.17))
mtext("Main model",3,line=0.1, cex=0.7)
text(0.05,0.95,"d)")

image(rho, rho, Eg.mat, xlab="", ylab="", asp=1, 
      main="",
      col=pal(50), zlim=c(-.015,.015))
tmpdf<-data.frame(z=c(Eg.mat), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T, levels=c(0.001,0.003,0.005,0.007,0.009,0.011))
mtext("Main model",3,line=0.1, cex=0.7)
text(0.05,0.95,"g)")

#difference - basic ricker
image(rho, rho, diff2.Ntcor, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-.3,.3))
tmpdf<-data.frame(z=c(diff2.Ntcor), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T)
mtext("Difference: alternate 1",3,line=0.1,cex=0.7)
mtext("Population spatial synchrony",3,line=1.1,cex=0.9)
text(0.05,0.95,"b)")

image(rho, rho, diff2.El, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-.15,.15))
tmpdf<-data.frame(z=c(diff2.El), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T, levels=c(0,0.02,0.04,0.06,0.08,0.1))
mtext("Difference: alternate 1",3,line=0.1,cex=0.7)
mtext("Local extinction rate",3,line=1.1,cex=0.9)
text(0.05,0.95,"e)")

image(rho, rho, diff2.Eg, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-.015,.015))
tmpdf<-data.frame(z=c(diff2.Eg), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T, levels=c(-0.003,-0.002,-0.001,0,0.001,0.002,0.003,0.004))
mtext("Difference: alternate 1",3,line=0.1,cex=0.7)
mtext("Global extinction rate",3,line=1.1,cex=0.9)
text(0.05,0.95,"h)")

#difference - alternate seasonal model
image(rho, rho, diff.Ntcor, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-.35,.35))
tmpdf<-data.frame(z=c(diff.Ntcor), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T)
mtext("Difference: alternate 2",3,line=0.1,cex=0.7)
text(0.05,0.95,"c)")

image(rho, rho, diff.El, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-.15,.15))
tmpdf<-data.frame(z=c(diff.El), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T, levels=c(-0.1,-0.08,-0.06,-0.04,-0.02,0))
mtext("Difference: alternate 2",3,line=0.1,cex=0.7)
text(0.05,0.95,"f)")

image(rho, rho, diff.Eg, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-.015,.015))
tmpdf<-data.frame(z=c(diff.Eg), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T, levels=c(-0.009,-0.007,-0.005,-0.003,-0.002,-0.001,0))
mtext("Difference: alternate 2",3,line=0.1,cex=0.7)
mtext("Spatial synchrony of breeding season environment",1,outer=T,cex=0.9)
mtext("Spatial synchrony of overwintering season environment",2,outer=T,cex=0.9)
text(0.05,0.95,"i)")

dev.off()



```

```{r ddall.varrhos.Db005, echo=FALSE, cache=TRUE}
library(parallel)
source("~/Box Sync/SynchronyLifestageModel/Fn_synchsim_main_20180822.R")
source("~/Box Sync/SynchronyLifestageModel/Fn_synchsim_main_alt_20180827.R")
source("~/Box Sync/SynchronyLifestageModel/Fn_synchsim_sameEnv_20181016.R")

scentxt<-"r08Db005Kb10"

rho<-seq(0,1,by=0.05)
rho.b<-rep(expand.grid(rho,rho)[,1],each=100)
rho.w<-rep(expand.grid(rho,rho)[,2],each=100)
r=0.8
Kb=10
Kw=Kb
sd.b=Kb/3.5
sd.w=Kw/3.5
Db=0.05
Dw=0
nlocs=2
tmax=550

ncores=detectCores()-1

cl<-makeCluster(ncores)
varrhos.main<-mcmapply(synchsim_main,r=r,Kb=Kb,Kw=Kw,rho.b=rho.b,rho.w=rho.w,
                        sd.b=sd.b,sd.w=sd.w,Db=Db,tmax=tmax,nlocs=nlocs, SIMPLIFY = F)
varrhos.alt<-mcmapply(synchsim_main_alt,r=r,Kb=Kb,Kw=Kw,rho.b=rho.b,rho.w=rho.w,
                        sd.b=sd.b,sd.w=sd.w,Db=Db,tmax=tmax,nlocs=nlocs, SIMPLIFY = F)
varrhos.basic<-mcmapply(synchsim_sameEnv,r=r,K=Kb,rho.b=rho.b,rho.w=rho.w,
                        sd.b=sd.b,sd.w=sd.w,Db=Db,tmax=tmax,nlocs=nlocs, SIMPLIFY = F)

stopCluster(cl)


getNtcor<-function(inlist){ #extract synchrony in Nt
  out<-rep(NA, length(inlist))
  for(ii in 1:length(inlist)){
    tmp<-log(inlist[[ii]]$Nt[,-c(1:50)]+1)
    tmprho<-cor(t(tmp), use = "pairwise.complete.obs")
    out[ii]<-mean(tmprho[lower.tri(tmprho)])
  }
  return(out)
}

getBtcor<-function(inlist){ #extract synchrony in Nt
  out<-rep(NA, length(inlist))
  for(ii in 1:length(inlist)){
    tmp<-log(inlist[[ii]]$Bt[,-c(1:50)]+1)
    tmprho<-cor(t(tmp), use = "pairwise.complete.obs")
    out[ii]<-mean(tmprho[lower.tri(tmprho)])
  }
  return(out)
}

getEl<-function(inlist){ #extract local extinction rate
  out<-rep(NA, length(inlist))
  for(ii in 1:length(inlist)){
    tmp<-inlist[[ii]]$Nt[,-c(1:50)]
    out[ii]<-sum(tmp==0,na.rm=T)/sum(!is.na(tmp))
  }
  return(out)
}

getEg<-function(inlist){ #extract global extinction rate
  out<-rep(NA, length(inlist))
  for(ii in 1:length(inlist)){
    tmp<-inlist[[ii]]$Nt[,-c(1:50)]
    if(all(is.na(tmp))){out[ii]<-NA}
    else if(sum(colSums(tmp)==0, na.rm=T)==0){out[ii]<-0}
    else{out[ii]<-1/(which(colSums(tmp)==0)+50)}
  }
  return(out)
}

Ntcor.df<-data.frame(rho.b=rho.b, rho.w=rho.w, Ntcor=getNtcor(varrhos.main))
Ntcor.agg<-aggregate(Ntcor.df, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Ntcor.mat<-matrix(Ntcor.agg$Ntcor, nrow=length(rho), ncol=length(rho))

Btcor.df<-data.frame(rho.b=rho.b, rho.w=rho.w, Btcor=getBtcor(varrhos.main))
Btcor.agg<-aggregate(Btcor.df, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Btcor.mat<-matrix(Btcor.agg$Btcor, nrow=length(rho), ncol=length(rho))

Ntcor.df.alt<-data.frame(rho.b=rho.b, rho.w=rho.w, Ntcor=getNtcor(varrhos.alt))
Ntcor.agg.alt<-aggregate(Ntcor.df.alt, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Ntcor.mat.alt<-matrix(Ntcor.agg.alt$Ntcor, nrow=length(rho), ncol=length(rho))

Ntcor.df.br<-data.frame(rho.b=rho.b, rho.w=rho.w, Ntcor=getNtcor(varrhos.basic))
Ntcor.agg.br<-aggregate(Ntcor.df.br, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Ntcor.mat.br<-matrix(Ntcor.agg.br$Ntcor, nrow=length(rho), ncol=length(rho))

El.df<-data.frame(rho.b=rho.b, rho.w=rho.w, El=getEl(varrhos.main))
El.agg<-aggregate(El.df, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
El.mat<-matrix(El.agg$El, nrow=length(rho), ncol=length(rho))

El.df.alt<-data.frame(rho.b=rho.b, rho.w=rho.w, El=getEl(varrhos.alt))
El.agg.alt<-aggregate(El.df.alt, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
El.mat.alt<-matrix(El.agg.alt$El, nrow=length(rho), ncol=length(rho))

El.df.br<-data.frame(rho.b=rho.b, rho.w=rho.w, El=getEl(varrhos.basic))
El.agg.br<-aggregate(El.df.br, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
El.mat.br<-matrix(El.agg.br$El, nrow=length(rho), ncol=length(rho))

Eg.df<-data.frame(rho.b=rho.b, rho.w=rho.w, Eg=getEg(varrhos.main))
Eg.agg<-aggregate(Eg.df, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Eg.mat<-matrix(Eg.agg$Eg, nrow=length(rho), ncol=length(rho))

Eg.df.alt<-data.frame(rho.b=rho.b, rho.w=rho.w, Eg=getEg(varrhos.alt))
Eg.agg.alt<-aggregate(Eg.df.alt, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Eg.mat.alt<-matrix(Eg.agg.alt$Eg, nrow=length(rho), ncol=length(rho))

Eg.df.br<-data.frame(rho.b=rho.b, rho.w=rho.w, Eg=getEg(varrhos.basic))
Eg.agg.br<-aggregate(Eg.df.br, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Eg.mat.br<-matrix(Eg.agg.br$Eg, nrow=length(rho), ncol=length(rho))

#avg.mat<-matrix(rowMeans(expand.grid(rho,rho)), nrow=length(rho), ncol=length(rho))
diff.Ntcor<-Ntcor.mat-Ntcor.mat.alt
diff.El<-El.mat-El.mat.alt
diff.Eg<-Eg.mat-Eg.mat.alt

diff2.Ntcor<-Ntcor.mat-Ntcor.mat.br
diff2.El<-El.mat-El.mat.br
diff2.Eg<-Eg.mat-Eg.mat.br

diff.NtBtcor<-Ntcor.mat-Btcor.mat

pal<-colorRampPalette(colors=c("red","white","blue"))


png(paste0("~/Box Sync/SynchronyLifestageModel/plotoutput/appendix_comparison_addnoise_",scentxt,".png"), units="in", res=300, width=6, height=6.55)

par(mfcol=c(3,3), mar=c(2,2,2.5,1), oma=c(1.5,1.5,0,0),mgp=c(2,0.6,0), tcl=-0.4)
#main model
image(rho, rho, Ntcor.mat, xlab="", ylab="", asp=1, 
      main="", col=pal(50), zlim=c(-1,1))
tmpdf<-data.frame(z=c(Ntcor.mat), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T)
mtext("Main model",3,line=0.1,cex=0.7)
text(0.05,0.95,"a)")

image(rho, rho, El.mat, xlab="", ylab="", asp=1, 
      main="", col=pal(50), zlim=c(-.25,.25))
tmpdf<-data.frame(z=c(El.mat), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T, levels=c(0.07,0.09,0.11,0.13))
mtext("Main model",3,line=0.1, cex=0.7)
text(0.05,0.95,"d)")

image(rho, rho, Eg.mat, xlab="", ylab="", asp=1, 
      main="",
      col=pal(50), zlim=c(-.015,.015))
tmpdf<-data.frame(z=c(Eg.mat), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T, levels=c(0.001,0.003,0.005,0.007,0.009,0.011))
mtext("Main model",3,line=0.1, cex=0.7)
text(0.05,0.95,"g)")
#difference - basic ricker
image(rho, rho, diff2.Ntcor, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-.3,.3))
tmpdf<-data.frame(z=c(diff2.Ntcor), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T)
mtext("Difference: alternate 1",3,line=0.1,cex=0.7)
mtext("Population spatial synchrony",3,line=1.1,cex=0.9)
text(0.05,0.95,"b)")

image(rho, rho, diff2.El, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-.15,.15))
tmpdf<-data.frame(z=c(diff2.El), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T, levels=c(-0.04,-0.02,0,0.02,0.04,0.06,0.08))
mtext("Difference: alternate 1",3,line=0.1,cex=0.7)
mtext("Local extinction rate",3,line=1.1,cex=0.9)
text(0.05,0.95,"e)")

image(rho, rho, diff2.Eg, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-.015,.015))
tmpdf<-data.frame(z=c(diff2.Eg), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T, levels=c(-0.003,-0.002,-0.001,0,0.001,0.002,0.003))
mtext("Difference: alternate 1",3,line=0.1,cex=0.7)
mtext("Global extinction rate",3,line=1.1,cex=0.9)
text(0.05,0.95,"h)")

#difference - alternate seasonal model
image(rho, rho, diff.Ntcor, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-.3,.3))
tmpdf<-data.frame(z=c(diff.Ntcor), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T)
mtext("Difference: alternate 2",3,line=0.1,cex=0.7)
text(0.05,0.95,"c)")

image(rho, rho, diff.El, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-.15,.15))
tmpdf<-data.frame(z=c(diff.El), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T, levels=c(-0.1,-0.08,-0.06,-0.04,-0.02,0))
mtext("Difference: alternate 2",3,line=0.1,cex=0.7)
text(0.05,0.95,"f)")

image(rho, rho, diff.Eg, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-.015,.015))
tmpdf<-data.frame(z=c(diff.Eg), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T, levels=c(-0.009,-0.007,-0.005,-0.003,-0.002,-0.001,0))
mtext("Difference: alternate 2",3,line=0.1,cex=0.7)
text(0.05,0.95,"i)")

mtext("Spatial synchrony of breeding season environment",1,outer=T,cex=0.9)
mtext("Spatial synchrony of overwintering season environment",2,outer=T,cex=0.9)

dev.off()

```

```{r ddall.varrhos.Db02, echo=FALSE, cache=TRUE}
library(parallel)
source("~/Box Sync/SynchronyLifestageModel/Fn_synchsim_main_20180822.R")
source("~/Box Sync/SynchronyLifestageModel/Fn_synchsim_main_alt_20180827.R")
source("~/Box Sync/SynchronyLifestageModel/Fn_synchsim_sameEnv_20181016.R")

scentxt<-"r08Db02Kb10"

rho<-seq(0,1,by=0.05)
rho.b<-rep(expand.grid(rho,rho)[,1],each=100)
rho.w<-rep(expand.grid(rho,rho)[,2],each=100)
r=0.8
Kb=10
Kw=Kb
sd.b=Kb/3.5
sd.w=Kw/3.5
Db=0.2
Dw=0
nlocs=2
tmax=550

ncores=detectCores()-1

cl<-makeCluster(ncores)
varrhos.main<-mcmapply(synchsim_main,r=r,Kb=Kb,Kw=Kw,rho.b=rho.b,rho.w=rho.w,
                        sd.b=sd.b,sd.w=sd.w,Db=Db,tmax=tmax,nlocs=nlocs, SIMPLIFY = F)
varrhos.alt<-mcmapply(synchsim_main_alt,r=r,Kb=Kb,Kw=Kw,rho.b=rho.b,rho.w=rho.w,
                        sd.b=sd.b,sd.w=sd.w,Db=Db,tmax=tmax,nlocs=nlocs, SIMPLIFY = F)
varrhos.basic<-mcmapply(synchsim_sameEnv,r=r,K=Kb,rho.b=rho.b,rho.w=rho.w,
                        sd.b=sd.b,sd.w=sd.w,Db=Db,tmax=tmax,nlocs=nlocs, SIMPLIFY = F)

stopCluster(cl)


getNtcor<-function(inlist){ #extract synchrony in Nt
  out<-rep(NA, length(inlist))
  for(ii in 1:length(inlist)){
    tmp<-log(inlist[[ii]]$Nt[,-c(1:50)]+1)
    tmprho<-cor(t(tmp), use = "pairwise.complete.obs")
    out[ii]<-mean(tmprho[lower.tri(tmprho)])
  }
  return(out)
}

getBtcor<-function(inlist){ #extract synchrony in Nt
  out<-rep(NA, length(inlist))
  for(ii in 1:length(inlist)){
    tmp<-log(inlist[[ii]]$Bt[,-c(1:50)]+1)
    tmprho<-cor(t(tmp), use = "pairwise.complete.obs")
    out[ii]<-mean(tmprho[lower.tri(tmprho)])
  }
  return(out)
}

getEl<-function(inlist){ #extract local extinction rate
  out<-rep(NA, length(inlist))
  for(ii in 1:length(inlist)){
    tmp<-inlist[[ii]]$Nt[,-c(1:50)]
    out[ii]<-sum(tmp==0,na.rm=T)/sum(!is.na(tmp))
  }
  return(out)
}

getEg<-function(inlist){ #extract global extinction rate
  out<-rep(NA, length(inlist))
  for(ii in 1:length(inlist)){
    tmp<-inlist[[ii]]$Nt[,-c(1:50)]
    if(all(is.na(tmp))){out[ii]<-NA}
    else if(sum(colSums(tmp)==0, na.rm=T)==0){out[ii]<-0}
    else{out[ii]<-1/(which(colSums(tmp)==0)+50)}
  }
  return(out)
}

Ntcor.df<-data.frame(rho.b=rho.b, rho.w=rho.w, Ntcor=getNtcor(varrhos.main))
Ntcor.agg<-aggregate(Ntcor.df, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Ntcor.mat<-matrix(Ntcor.agg$Ntcor, nrow=length(rho), ncol=length(rho))

Btcor.df<-data.frame(rho.b=rho.b, rho.w=rho.w, Btcor=getBtcor(varrhos.main))
Btcor.agg<-aggregate(Btcor.df, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Btcor.mat<-matrix(Btcor.agg$Btcor, nrow=length(rho), ncol=length(rho))

Ntcor.df.alt<-data.frame(rho.b=rho.b, rho.w=rho.w, Ntcor=getNtcor(varrhos.alt))
Ntcor.agg.alt<-aggregate(Ntcor.df.alt, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Ntcor.mat.alt<-matrix(Ntcor.agg.alt$Ntcor, nrow=length(rho), ncol=length(rho))

Ntcor.df.br<-data.frame(rho.b=rho.b, rho.w=rho.w, Ntcor=getNtcor(varrhos.basic))
Ntcor.agg.br<-aggregate(Ntcor.df.br, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Ntcor.mat.br<-matrix(Ntcor.agg.br$Ntcor, nrow=length(rho), ncol=length(rho))

El.df<-data.frame(rho.b=rho.b, rho.w=rho.w, El=getEl(varrhos.main))
El.agg<-aggregate(El.df, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
El.mat<-matrix(El.agg$El, nrow=length(rho), ncol=length(rho))

El.df.alt<-data.frame(rho.b=rho.b, rho.w=rho.w, El=getEl(varrhos.alt))
El.agg.alt<-aggregate(El.df.alt, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
El.mat.alt<-matrix(El.agg.alt$El, nrow=length(rho), ncol=length(rho))

El.df.br<-data.frame(rho.b=rho.b, rho.w=rho.w, El=getEl(varrhos.basic))
El.agg.br<-aggregate(El.df.br, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
El.mat.br<-matrix(El.agg.br$El, nrow=length(rho), ncol=length(rho))

Eg.df<-data.frame(rho.b=rho.b, rho.w=rho.w, Eg=getEg(varrhos.main))
Eg.agg<-aggregate(Eg.df, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Eg.mat<-matrix(Eg.agg$Eg, nrow=length(rho), ncol=length(rho))

Eg.df.alt<-data.frame(rho.b=rho.b, rho.w=rho.w, Eg=getEg(varrhos.alt))
Eg.agg.alt<-aggregate(Eg.df.alt, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Eg.mat.alt<-matrix(Eg.agg.alt$Eg, nrow=length(rho), ncol=length(rho))

Eg.df.br<-data.frame(rho.b=rho.b, rho.w=rho.w, Eg=getEg(varrhos.basic))
Eg.agg.br<-aggregate(Eg.df.br, by=list(rho.b, rho.w), FUN=mean, na.rm=T)
Eg.mat.br<-matrix(Eg.agg.br$Eg, nrow=length(rho), ncol=length(rho))

#avg.mat<-matrix(rowMeans(expand.grid(rho,rho)), nrow=length(rho), ncol=length(rho))
diff.Ntcor<-Ntcor.mat-Ntcor.mat.alt
diff.El<-El.mat-El.mat.alt
diff.Eg<-Eg.mat-Eg.mat.alt

diff2.Ntcor<-Ntcor.mat-Ntcor.mat.br
diff2.El<-El.mat-El.mat.br
diff2.Eg<-Eg.mat-Eg.mat.br

diff.NtBtcor<-Ntcor.mat-Btcor.mat

pal<-colorRampPalette(colors=c("red","white","blue"))


png(paste0("~/Box Sync/SynchronyLifestageModel/plotoutput/appendix_comparison_addnoise_",scentxt,".png"), units="in", res=300, width=6, height=6.55)

par(mfcol=c(3,3), mar=c(2,2,2.5,1), oma=c(1.5,1.5,0,0),mgp=c(2,0.6,0), tcl=-0.4)
#main model
image(rho, rho, Ntcor.mat, xlab="", ylab="", asp=1, 
      main="", col=pal(50), zlim=c(-1,1))
tmpdf<-data.frame(z=c(Ntcor.mat), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T)
mtext("Main model",3,line=0.1,cex=0.7)
text(0.05,0.95,"a)")

image(rho, rho, El.mat, xlab="", ylab="", asp=1, 
      main="", col=pal(50), zlim=c(-.3,.3))
tmpdf<-data.frame(z=c(El.mat), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T, levels=c(0.07,0.09,0.11,0.13))
mtext("Main model",3,line=0.1, cex=0.7)
text(0.05,0.95,"d)")

image(rho, rho, Eg.mat, xlab="", ylab="", asp=1, 
      main="",
      col=pal(50), zlim=c(-.015,.015))
tmpdf<-data.frame(z=c(Eg.mat), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T, levels=c(0.001,0.003,0.005,0.007,0.009,0.011))
mtext("Main model",3,line=0.1, cex=0.7)
text(0.05,0.95,"g)")

#difference - basic ricker
image(rho, rho, diff2.Ntcor, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-.4,.4))
tmpdf<-data.frame(z=c(diff2.Ntcor), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T)
mtext("Difference: alternate 1",3,line=0.1,cex=0.7)
mtext("Population spatial synchrony",3,line=1.1,cex=0.9)
text(0.05,0.95,"b)")

image(rho, rho, diff2.El, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-.15,.15))
tmpdf<-data.frame(z=c(diff2.El), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T, levels=c(-0.04,-0.02,0,0.02,0.04,0.06,0.08))
mtext("Difference: alternate 1",3,line=0.1,cex=0.7)
mtext("Local extinction rate",3,line=1.1,cex=0.9)
text(0.05,0.95,"e)")

image(rho, rho, diff2.Eg, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-.015,.015))
tmpdf<-data.frame(z=c(diff2.Eg), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T, levels=c(-0.003,-0.002,-0.001,0,0.001,0.002,0.003))
mtext("Difference: alternate 1",3,line=0.1,cex=0.7)
mtext("Global extinction rate",3,line=1.1,cex=0.9)
text(0.05,0.95,"h)")
#difference - alternate seasonal model
image(rho, rho, diff.Ntcor, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-.3,.3))
tmpdf<-data.frame(z=c(diff.Ntcor), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T)
mtext("Difference: alternate 2",3,line=0.1,cex=0.7)
text(0.05,0.95,"c)")

image(rho, rho, diff.El, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-.15,.15))
tmpdf<-data.frame(z=c(diff.El), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T, levels=c(-0.1,-0.08,-0.06,-0.04,-0.02,0))
mtext("Difference: alternate 2",3,line=0.1,cex=0.7)
text(0.05,0.95,"f)")
image(rho, rho, diff.Eg, xlab="", ylab="", asp=1, main="",
      col=pal(50), zlim=c(-.015,.015))
tmpdf<-data.frame(z=c(diff.Eg), x=expand.grid(rho,rho)[,1], y=expand.grid(rho,rho)[,2])
sm<-matrix(predict(loess(z~x+y, data=tmpdf, span=0.1)),length(rho),length(rho))
contour(rho, rho, sm, add=T, levels=c(-0.009,-0.007,-0.005,-0.003,-0.002,-0.001,0))
mtext("Difference: alternate 2",3,line=0.1,cex=0.7)
text(0.05,0.95,"i)")

mtext("Spatial synchrony of breeding season environment",1,outer=T,cex=0.9)
mtext("Spatial synchrony of overwintering season environment",2,outer=T,cex=0.9)

dev.off()

```